<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Vehicle Location with Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: radial-gradient(circle, rgba(58,123,213,1) 0%, rgba(58,191,223,1) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #fff;
            overflow: hidden;
        }

        .container {
            text-align: center;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            max-width: 600px;
            width: 90%;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        h1 {
            font-size: 36px;
            margin-bottom: 20px;
            font-weight: 700;
            color: #fff;
        }

        #coordinates {
            font-size: 24px;
            font-weight: 400;
            color: #fff;
            margin-bottom: 20px;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        .loader {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 8px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        footer {
            margin-top: 20px;
            font-size: 14px;
            color: #fff;
        }

        .animate-fade {
            animation: fadeIn 0.6s ease-in-out;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container animate-fade">
        <h1>Live Vehicle Location</h1>
        <div id="coordinates">
            <div class="loader"></div>
            Loading...
        </div>

        <div class="button-container">
            <button id="refreshButton">Refresh Location</button>
            <button id="centerButton">Center on Vehicle</button>
        </div>

        <div id="map"></div>

        <footer>
            &copy; 2024 Live Vehicle Tracking
        </footer>
    </div>

    <!-- Leaflet JS for map -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Supabase JS for database integration -->
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/dist/umd/supabase.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Initialize Supabase after DOM and JS libraries are loaded
            const supabaseUrl = 'https://awelblmpqllkmcqrfbyl.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3ZWxibG1wcWxsa21jcXJmYnlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjkyMzA0NjMsImV4cCI6MjA0NDgwNjQ2M30.CKnjIm4gNbnw9INekYWAioNT1BbpgPYcBWnnsVhsxDQ';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            // Initialize Leaflet map with a closer default zoom
            const map = L.map('map').setView([20, 77], 7);

            // Load map tiles from OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Create a marker with a default position
            let marker = L.marker([20, 77]).addTo(map);

            // Function to fetch and update coordinates on the map
            async function fetchLatestCoordinates() {
                try {
                    const { data, error } = await supabase
                        .from('coordinates')
                        .select('latitude, longitude')
                        .order('id', { ascending: false })
                        .limit(1);

                    if (error) {
                        console.error('Error fetching coordinates:', error);
                        document.getElementById('coordinates').innerText = `Error: ${error.message}`;
                        return;
                    }

                    if (data && data.length > 0) {
                        const latitude = parseFloat(data[0].latitude);
                        const longitude = parseFloat(data[0].longitude);

                        // Update coordinates text
                        document.getElementById('coordinates').innerText = `Latitude: ${latitude}, Longitude: ${longitude}`;

                        // Update map view and marker position with closer zoom
                        map.setView([latitude, longitude], 15);  // Zoom in closer to the vehicle
                        marker.setLatLng([latitude, longitude]);
                    } else {
                        document.getElementById('coordinates').innerText = 'No coordinates found.';
                    }
                } catch (err) {
                    console.error('An error occurred:', err);
                    document.getElementById('coordinates').innerText = 'Error fetching coordinates.';
                }
            }

            // Fetch the latest coordinates on page load
            fetchLatestCoordinates();

            // Refresh button functionality
            document.getElementById('refreshButton').addEventListener('click', fetchLatestCoordinates);

            // Center button functionality
            document.getElementById('centerButton').addEventListener('click', () => {
                if (marker.getLatLng()) {
                    map.setView(marker.getLatLng(), 15);  // Keep the zoom level closer to vehicle
                }
            });

            // Optionally, refresh the coordinates and map every few seconds for live updates
            setInterval(fetchLatestCoordinates, 5000);  // Refresh every 5 seconds
        });
    </script>
</body>
</html>
